version: '3.8'

services:
  # API with memory optimization (no SQL Server in this compose)
  api:
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__SqlServerConnection: "Server=${SQL_SERVER_HOST:-shared-sqlserver},1433;Database=ReampDb;User Id=sa;Password=${SQL_SERVER_PASSWORD};TrustServerCert=True;MultipleActiveResultSets=true"
      JwtSettings__Secret: "${JWT_SECRET}"
      JwtSettings__Issuer: "${JWT_ISSUER}"
      JwtSettings__Audience: "${JWT_AUDIENCE}"
      Cloudinary__CloudName: "${CLOUDINARY_CLOUD_NAME}"
      Cloudinary__ApiKey: "${CLOUDINARY_API_KEY}"
      Cloudinary__ApiSecret: "${CLOUDINARY_API_SECRET}"
      Cors__AllowedOrigins__0: "${FRONTEND_URL}"
      # .NET Runtime optimization for low memory
      DOTNET_GCHeapHardLimit: 200000000  # 200MB heap limit
      DOTNET_GCConserveMemory: 9  # Aggressive memory conservation (1-9)
    restart: always
    # Resource limits for API only (no SQL Server)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 300M
        reservations:
          cpus: '0.25'
          memory: 150M
